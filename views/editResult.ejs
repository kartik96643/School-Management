<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Edit Student Result</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .container {
      max-width: 900px;
    }

    .card {
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    table th,
    table td {
      text-align: center;
      vertical-align: middle;
    }

    .table thead {
      background-color: #343a40;
      color: #fff;
    }
  </style>
</head>

<body>

  <div class="container mt-5">
    <% if (!result) { %>
      <div class="card p-4">
        <h3 class="mb-4 text-center text-primary">Edit Student Result</h3>
        <form action="/result/editResult" method="post">

          <div class="mb-3">
            <label for="classFilter" class="form-label">Class</label>
            <select name="studentClass" id="classFilter" class="form-select" required>
              <option value="">Select Class</option>
              <option value="Nursery">Nursery</option>
              <option value="LKG">LKG</option>
              <option value="UKG">UKG</option>
              <% for (let i=1; i <=12; i++) { %>
                <option value="<%= i %>">
                  <%= i %>
                </option>
                <% } %>
            </select>
          </div>

          <div class="mb-3" id="streamGroup" style="display: none;">
            <label for="streamFilter" class="form-label">Select Stream</label>
            <select class="form-select" id="streamFilter" name="stream">
              <option value="">-- Select Stream --</option>
              <option value="Arts">Arts</option>
              <option value="Science">Science</option>
              <option value="Commerce">Commerce</option>
            </select>
          </div>

          <div class="mb-3">
                  <label for="mediumFilter" class="form-label">Select Medium</label>
                  <select class="form-select" id="mediumFilter" name="medium" required>
                    <option value="">-- Select Medium --</option>
                    <option value="English" >English</option>
                    <option value="Hindi">Hindi</option>
                  </select>
                </div>

          <div class="mb-3">
            <label for="examType" class="form-label">Exam Type</label>
            <input type="text" name="examType" id="examType" class="form-control" required>
          </div>

          <div class="mb-3">
            <label for="session" class="form-label">Academic Session</label>
            <input type="text" class="form-control" id="session" name="session" required pattern="^\d{4}-\d{2}$"
              title="Format: YYYY-YY" placeholder="Enter session like 2023-24">
          </div>

          <div class="text-center">
            <button type="submit" class="btn btn-primary px-4">Load Result for Editing</button>
            <a href="/result" class="btn btn-primary ">Back</a>
          </div>
        </form>
      </div>
      <% } else { %>
        <div class="container my-5">
          <h3 class="text-center text-primary mb-4">Edit Results for Class <%= result[0]?.studentClass %>(<%= students[0].stream  %>) - <%=
                result[0]?.session %> - <%= result[0]?.examType %>
          </h3>

          <form action="/result/updateResult" method="POST">
           <input type="hidden" name="studentClass" value="<%= result[0].studentClass %>">
<input type="hidden" name="session" value="<%= result[0].session %>">
<input type="hidden" name="examType" value="<%= result[0].examType %>">

            <div class="table-responsive">
              <table class="table table-bordered table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Reg. No.</th>
                    <th>Name</th>
                    <% if (result.length> 0 && students.length > 0) {
                      result[0].subjects.forEach((subj, sIndex) => { %>
                      <th>
                        <%= subj.name %><br>(Obtained / Total)
                      </th>
                      <% }) } %>
                  </tr>
                </thead>
                <tbody>
                  <% result.forEach((r, index)=> { %>
                    <tr>
                      <td>
                        <input type="hidden" name="students[<%= index %>][registrationNo]"
                          value="<%= r.registrationNo %>">
                        <%= r.registrationNo %>
                      </td>
                      <td>
                        <%= (students.find(s=> s.registrationNo === r.registrationNo)?.studentName) || "N/A" %>
                      </td>
                      <% r.subjects.forEach((subject, sIndex)=> { %>
                        <td>
                          <input type="hidden" name="students[<%= index %>][subjects][<%= sIndex %>][name]"
                            value="<%= subject.name %>">
                          <input type="number" class="form-control mb-1"
                            name="students[<%= index %>][subjects][<%= sIndex %>][obtainedMarks]"
                            value="<%= subject.obtainedMarks %>" min="0">
                          <input type="number" class="form-control"
                            name="students[<%= index %>][subjects][<%= sIndex %>][totalMarks]"
                            value="<%= subject.totalMarks %>" min="0">
                        </td>
                        <% }) %>
                    </tr>
                    <% }) %>
                </tbody>
              </table>
            </div>

            <div class="text-center mt-4">
              <button type="submit" class="btn btn-success px-5">Update All Results</button>
            </div>
          </form>
        </div>
        <% } %>
  </div>

  <script>
    document.getElementById('classFilter').addEventListener('change', function () {
      const selectedClass = this.value;
      const streamGroup = document.getElementById('streamGroup');

      if (selectedClass === '11' || selectedClass === '12') {
        streamGroup.style.display = 'block';
        document.getElementById('streamFilter').setAttribute('required', 'required');
      } else {
        streamGroup.style.display = 'none';
        document.getElementById('streamFilter').removeAttribute('required');
        document.getElementById('streamFilter').value = '';
      }
    });

  </script>
</body>

</html>