<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Attendance Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f8f9fa; padding:24px; font-family: system-ui, Arial; }
    .report-card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    table { width:100%; border-collapse:collapse; font-size:13px; }
    th, td { border:1px solid #e9ecef; padding:6px 8px; text-align:center; white-space:nowrap; }
    th { background:#0d6efd; color:#fff; font-weight:600; }
    .name-col { text-align:left; font-weight:600; max-width:80px; }
    .badge-P { background:#198754; color:#fff; padding:2px 6px; border-radius:4px; }
    .badge-A { background:#dc3545; color:#fff; padding:2px 6px; border-radius:4px;}
    .badge-NA { background:#6c757d; color:#fff; padding:2px 6px; border-radius:4px; }
    .small-muted { font-size:12px; color:#6c757d; }
    @media print {
      .no-print{
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="report-card">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h4 class="mb-0">Attendance Report</h4>
          <div class="small-muted">
            Class: <%= className %> • Medium: <%= medium %>
            <% if (className === '11' || className === '12') { %> • Stream: <%= stream %><% } %>
            • Range: <%= startDate %> → <%= endDate %>
          </div>
        </div>
        <div class="small-muted text-end">
          <div>Total Days: <strong><%= dates.length %></strong></div>
        </div>
      </div>

      <% if (!tableData || tableData.length === 0) { %>
        <div class="alert alert-warning mb-0">No attendance records found for this filter.</div>
      <% } else { %>

        <% 
          // Normalizer helper: returns 'P' or 'A' or null (for missing/unknown)
          function normalizeStatus(v) {
            if (v === undefined || v === null) return null;
            const s = String(v).trim().toLowerCase();
            if (s === 'p' || s === 'present' || s.startsWith('p')) return 'P';
            if (s === 'a' || s === 'absent' || s.startsWith('a')) return 'A';
            if (s === 'l' || s === 'leave' || s.startsWith('l')) return 'L';
            return null;
          }

          const totalDays = dates.length; // denominator used for percentage
        %>

        <div class="table-responsive" style="max-width:100%; overflow:auto;">
          <table class="table table-hover">
            <thead>
              <tr>
                <th style="max-width:20px">S.No.</th>
                <th class="name-col">Student (%)</th>
                <th style="max-width:50px">Total Present / Days</th>
                <% dates.forEach(d => { %>
                  <th style="max-width:20px;"><%= new Date(d).toLocaleDateString() %></th>
                <% }) %>
              </tr>
            </thead>

            <tbody>
              <% tableData.forEach((student, idx) => { 
                   // compute present & (optionally) marked days
                   let presentCount = 0;
                   // If you want to exclude NA from denominator change the denominator calc below.
                   dates.forEach(d => {
                     const s = normalizeStatus(student.attendance[d]);
                     if (s === 'P') presentCount++;
                   });
                   const pct = totalDays > 0 ? Math.round((presentCount / totalDays) * 100) : 0;
              %>
                <tr>
                  <td><%= idx + 1 %></td>
                  <td class="name-col"><%= student.name || 'Unknown' %> (<%= pct %>%)</td>
                  <td><%= presentCount %> / <%= totalDays %></td>

                  <% dates.forEach(d => { 
                       const s = normalizeStatus(student.attendance[d]);
                       if (s === 'P') { %>
                          <td><span class="badge-P">P</span></td>
                       <% } else if (s === 'A') { %>
                          <td><span class="badge-A">A</span></td>
                       <% } else { %>
                          <td><span class="badge-NA">L</span></td>
                       <% } %>
                  <% }) %>
                </tr>
              <% }) %>
            </tbody>

            </table>
            </div>
            <button class="btn"><a href="/attendance/getData-form" class="btn btn-primary no-print ">Back to filter</a></button>
            <button onclick="window.print()" class="btn btn-primary no-print">Print</button>
      <% } %>
    </div>
  </div>
</body>
</html>
