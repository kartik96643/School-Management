<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Edit Student Result</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .container {
            max-width: 900px;
        }

        .card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        table th,
        table td {
            text-align: center;
            vertical-align: middle;
        }

        .table thead {
            background-color: #343a40;
            color: #fff;
        }

        @media print{
            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body>

    <div class="container mt-5">
        <% if (!result) { %>
            <div class="card p-4">
                <h3 class="mb-4 text-center text-primary"> Result Summary</h3>
                <form action="/result/summary" method="post">

                    <div class="mb-3">
                        <label for="classFilter" class="form-label">Class</label>
                        <select name="studentClass" id="classFilter" class="form-select" required>
                            <option value="">Select Class</option>
                            <option value="Nursery">Nursery</option>
                            <option value="LKG">LKG</option>
                            <option value="UKG">UKG</option>
                            <% for (let i=1; i <=12; i++) { %>
                                <option value="<%= i %>">
                                    <%= i %>
                                </option>
                                <% } %>
                        </select>
                    </div>

                    <div class="mb-3" id="streamGroup" style="display: none;">
                        <label for="streamFilter" class="form-label">Select Stream</label>
                        <select class="form-select" id="streamFilter" name="stream">
                            <option value="">-- Select Stream --</option>
                            <option value="Arts">Arts</option>
                            <option value="Science">Science</option>
                            <option value="Commerce">Commerce</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="mediumFilter" class="form-label">Select Medium</label>
                        <select class="form-select" id="mediumFilter" name="medium" required>
                            <option value="">-- Select Medium --</option>
                            <option value="English">English</option>
                            <option value="Hindi">Hindi</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="examType" class="form-label">Exam Type</label>
                        <input type="text" name="examType" id="examType" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label for="session" class="form-label">Academic Session</label>
                        <input type="text" class="form-control" id="session" name="session" required
                            pattern="^\d{4}-\d{2}$" title="Format: YYYY-YY" placeholder="Enter session like 2023-24">
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary px-4">Load Result </button>
                                    <a href="/result" class="btn btn-primary ">Back</a>

                    </div>
                </form>
            </div>
            <% } else { %>
                <div class="container my-5">
  <div class="text-center mb-4">
    <h2 class="fw-bold text-primary">Class <%= result[0]?.studentClass %> Results</h2>
    <h5 class="text-secondary">
      Stream: <%= students[0]?.stream || "N/A" %> | 
      Medium: <%= students[0]?.medium || 'N/A'  %> |
      Session: <%= result[0]?.session %> | 
      Exam: <%= result[0]?.examType %>
    </h5>
  </div>

  <% 
    let totalStudents = result.length;
    let passCount = 0;
    let failCount = 0;
  %>

  <div class="card shadow rounded-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered align-middle table-hover text-center">
          <thead class="table-primary text-dark">
            <tr>
              <th>Reg. No.</th>
              <th>Name</th>
              <% if (result[0]?.subjects) {
                result[0].subjects.forEach((subject) => { %>
                  <th><%= subject.name %><br><small>(obt.-marks)</small></th>
              <% }) } %>
              <th>Total Marks</th>
              <th>Percentage</th>
              <th>Grade</th>
              <th>Division</th>
            </tr>
          </thead>
          <tbody class="table-light">
            <% result.forEach((r) => {
                const student = students.find(s => s.registrationNo === r.registrationNo);
                const name = student?.studentName || "N/A";

                let totalObtained = 0;
                let totalMax = 0;

                r.subjects.forEach(sub => {
                  totalObtained += Number(sub.obtainedMarks);
                  totalMax += Number(sub.totalMarks);
                });

                const percentage = (totalObtained / totalMax) * 100;

                let grade = "";
                if (percentage >= 90) grade = "A+";
                else if (percentage >= 80) grade = "A";
                else if (percentage >= 70) grade = "B";
                else if (percentage >= 60) grade = "C";
                else if (percentage >= 50) grade = "D";
                else grade = "F";

                if (grade === "F") failCount++;
                else passCount++;

                 let division = "";
    if (percentage >= 60) division = "First Division";
    else if (percentage >= 45) division = "Second Division";
    else if (percentage >= 33) division = "Third Division";
    else division = "Fail";
            %>
              <tr>
                <td><%= r.registrationNo %></td>
                <td class="fw-semibold text-start"><%= name %></td>
                <% r.subjects.forEach(sub => { %>
                  <td><%= sub.obtainedMarks %></td>
                <% }) %>
                <td><%= totalObtained %> / <%= totalMax %></td>
                <td><%= percentage.toFixed(2) %>%</td>
                <td class="fw-bold <%= grade === 'F' ? 'text-danger' : 'text-success' %>"><%= grade %></td>
                                <td><%= division %></td>

              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row text-center mt-5">
    <div class="col-md-4">
      <div class="bg-primary bg-opacity-10 border-start border-4 border-primary rounded p-3 shadow-sm">
        <h6 class="text-primary mb-1">Total Students</h6>
        <h4 class="fw-bold"><%= totalStudents %></h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="bg-success bg-opacity-10 border-start border-4 border-success rounded p-3 shadow-sm">
        <h6 class="text-success mb-1">Passed Students</h6>
        <h4 class="fw-bold"><%= passCount %></h4>
      </div>
    </div>
    <div class="col-md-4">
      <div class="bg-danger bg-opacity-10 border-start border-4 border-danger rounded p-3 shadow-sm">
        <h6 class="text-danger mb-1">Failed Students</h6>
        <h4 class="fw-bold"><%= failCount %></h4>
      </div>
    </div>
  </div>
</div>
<div class="text-center mt-3">
    <button class="btn btn-primary no-print" onclick="window.print()">Print</button>
    <a href="/result/summary" class="btn btn-primary no-print">Back</a>
    </div>
                <% } %>
    </div>

    <script>
        document.getElementById('classFilter').addEventListener('change', function () {
            const selectedClass = this.value;
            const streamGroup = document.getElementById('streamGroup');

            if (selectedClass === '11' || selectedClass === '12') {
                streamGroup.style.display = 'block';
                document.getElementById('streamFilter').setAttribute('required', 'required');
            } else {
                streamGroup.style.display = 'none';
                document.getElementById('streamFilter').removeAttribute('required');
                document.getElementById('streamFilter').value = '';
            }
        });

    </script>
</body>

</html>